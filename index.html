<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA CMS INSTALADOR - UZZE Mﾃｭdia TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .tab-button.active { border-color: #84cc16; color: #84cc16; background-color: #ecfccb; }
        #qr-reader { border: 2px solid #84cc16; border-radius: 8px; }
        .drive-item:hover { background-color: #374151; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Tela de Autenticaﾃｧﾃ｣o -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold mb-2"><span style="color: #84cc16;">UZZE</span><span>Mﾃ好IA TV</span></h1>
            <h2 class="text-xl font-semibold text-gray-300 mb-6">CMS INSTALADOR</h2>
            <p id="auth-message" class="text-yellow-400 mb-4"></p>
            <button id="login-button" class="w-full bg-lime-500 hover:bg-lime-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-300">Entrar com Google</button>
        </div>
    </div>

    <!-- Aplicaﾃｧﾃ｣o Principal -->
    <div id="main-app" class="hidden">
        <header class="bg-gray-800 p-4 shadow-md flex justify-between items-center">
            <h1 class="text-2xl font-bold"><span style="color: #84cc16;">UZZE</span><span class="text-white"> Mﾃ好IA - INSTALADOR</span></h1>
            <div>
                <span id="user-info" class="text-sm text-gray-300 mr-4"></span>
                <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Sair</button>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <div class="mb-6 border-b border-gray-700">
                <nav class="flex flex-wrap space-x-2 sm:space-x-4 text-sm sm:text-base" aria-label="Tabs">
                    <button class="tab-button active" data-tab="tab-monitoring">Monitoramento</button>
                    <button class="tab-button" data-tab="tab-activation">Ativaﾃｧﾃ｣o de App</button>
                    <button class="tab-button" data-tab="tab-drive">Hospedagem de Artes</button>
                    <button class="tab-button" data-tab="tab-maintenance">Manutenﾃｧﾃ｣o</button>
                    <button class="tab-button" data-tab="tab-advisory">Aviso Inadimplﾃｪncia</button>
                </nav>
            </div>

            <!-- Conteﾃｺdo das Abas -->
            <div id="tab-monitoring" class="tab-content"></div>
            <div id="tab-activation" class="tab-content hidden"></div>
            <div id="tab-drive" class="tab-content hidden"></div>
            <div id="tab-maintenance" class="tab-content hidden"></div>
            <div id="tab-advisory" class="tab-content hidden"></div>

        </main>
    </div>

    <!-- Modal de Ativaﾃｧﾃ｣o -->
    <div id="activation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-lime-400">Ativar Novo Dispositivo</h3>
            <form id="activation-form" class="space-y-3">
                <input type="text" id="device-uid" class="w-full p-2 bg-gray-700 rounded border-gray-600" readonly>
                <input type="text" id="device-ns" class="w-full p-2 bg-gray-700 rounded border-gray-600" readonly>
                <input type="text" id="client-name" placeholder="Nome do Cliente" class="w-full p-2 bg-gray-700 rounded border-gray-600" required>
                <input type="tel" id="client-phone" placeholder="Telefone do Cliente" class="w-full p-2 bg-gray-700 rounded border-gray-600" required>
                <input type="text" id="device-name" placeholder="Nome do Dispositivo (Ex: TV da Loja)" class="w-full p-2 bg-gray-700 rounded border-gray-600" required>
                <select id="license-select" class="w-full p-2 bg-gray-700 rounded border-gray-600" required></select>
                <select id="validity-select" class="w-full p-2 bg-gray-700 rounded border-gray-600" required>
                    <option value="">Selecione a Validade</option>
                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i} Mﾃｪs${i>1?'es':''}</option>`);</script>
                </select>
                <input type="url" id="drive-link" placeholder="Link da Pasta Google Drive (Opcional)" class="w-full p-2 bg-gray-700 rounded border-gray-600">
                <div class="flex space-x-4 mt-4">
                    <button type="submit" class="w-full bg-lime-500 text-gray-900 font-bold py-2 rounded">Salvar e Ativar</button>
                    <button type="button" id="cancel-activation" class="w-full bg-gray-600 text-white font-bold py-2 rounded">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal genﾃｩrico para notificaﾃｧﾃｵes -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="notification-title" class="text-xl font-bold mb-4">Aviso</h3>
            <p id="notification-message"></p>
            <button id="notification-close" class="mt-6 w-full bg-lime-500 text-gray-900 font-bold py-2 px-4 rounded-lg">Fechar</button>
        </div>
    </div>


    <script type="module">
        // --- SDKs E CONFIGURAﾃﾃ髭S ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, query, where, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_2iw6P97toez8A65xfB2-GB6lBKckffI",
            authDomain: "uzzemidiatv.firebaseapp.com",
            projectId: "uzzemidiatv",
            storageBucket: "uzzemidiatv.firebasestorage.app",
            messagingSenderId: "717413301017",
            appId: "1:717413301017:web:6da6a0223db091c4a0e388",
        };
        
        // Google Drive API Config
        const GOOGLE_API_KEY = "AIzaSyDW7GyR3PZBnIPQQmIWZE0rHKfMT4XUNTM";
        const GOOGLE_CLIENT_ID = "339438040741-ksdo2bfk3r6jvm69g06p87v9krh562q6.apps.googleusercontent.com";
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive';
        let tokenClient;


        // --- INICIALIZAﾃﾃグ ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        let currentInstaller = null;
        let devicesUnsubscribe = null;

        // --- ELEMENTOS DA UI ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userInfoEl = document.getElementById('user-info');
        const authMessage = document.getElementById('auth-message');
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = {
            monitoring: document.getElementById('tab-monitoring'),
            activation: document.getElementById('tab-activation'),
            drive: document.getElementById('tab-drive'),
            maintenance: document.getElementById('tab-maintenance'),
            advisory: document.getElementById('tab-advisory'),
        };
        const activationModal = document.getElementById('activation-modal');


        // --- AUTENTICAﾃﾃグ E CONTROLE DE ACESSO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const installerRef = doc(db, 'installers', user.email.toLowerCase());
                const installerSnap = await getDoc(installerRef);
                if (installerSnap.exists()) {
                    currentInstaller = { id: installerSnap.id, ...installerSnap.data() };
                    authScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    userInfoEl.textContent = currentInstaller.name;
                    initializeTabs();
                    initializeGapiClient();
                } else {
                    authMessage.textContent = 'Acesso negado. Sua conta nﾃ｣o estﾃ｡ registrada.';
                    signOut(auth);
                }
            } else {
                currentInstaller = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                if(devicesUnsubscribe) devicesUnsubscribe();
            }
        });

        loginButton.addEventListener('click', () => signInWithPopup(auth, provider).catch(err => showNotification("Erro de Login", err.message)));
        logoutButton.addEventListener('click', () => signOut(auth));


        // --- NAVEGAﾃﾃグ POR ABAS ---
        tabs.forEach(button => {
            button.addEventListener('click', () => {
                tabs.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                Object.values(tabContents).forEach(content => content.classList.add('hidden'));
                tabContents[button.dataset.tab.split('-')[1]].classList.remove('hidden');
            });
        });

        function initializeTabs() {
            renderMonitoringTab();
            renderActivationTab();
            renderDriveTab();
            renderMaintenanceTab();
            renderAdvisoryTab();
            listenToDevices();
        }

        // --- ABA DE MONITORAMENTO ---
        function listenToDevices() {
             if (devicesUnsubscribe) devicesUnsubscribe(); // Cancela listener anterior
             const q = query(collection(db, "devices"), where("installerId", "==", currentInstaller.id));
             devicesUnsubscribe = onSnapshot(q, (snapshot) => {
                const devices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.querySelector('.tab-button[data-tab="tab-monitoring"]').classList.contains('active')) {
                     renderMonitoringTab(devices);
                }
                if (document.querySelector('.tab-button[data-tab="tab-maintenance"]').classList.contains('active')) {
                     renderMaintenanceTab(devices);
                }
                if (document.querySelector('.tab-button[data-tab="tab-advisory"]').classList.contains('active')) {
                     renderAdvisoryTab(devices);
                }
             });
        }
        
        function renderMonitoringTab(devices = []) {
            const getStatusBadge = (status) => {
                const colors = {
                    active: 'bg-green-500',
                    no_playlist: 'bg-yellow-500',
                    connection_lost: 'bg-red-500',
                    blocked: 'bg-gray-600'
                };
                const text = {
                    active: 'Funcionando',
                    no_playlist: 'Sem Playlist',
                    connection_lost: 'Desconectado',
                    blocked: 'Bloqueado'
                }
                return `<span class="px-2 py-1 text-xs font-semibold rounded-full text-white ${colors[status] || 'bg-gray-500'}">${text[status] || status}</span>`;
            };

            let content = `<h2 class="text-2xl font-bold mb-4 text-lime-400">Dispositivos Ativos</h2>`;
            if (devices.length === 0) {
                content += `<p>Nenhum dispositivo ativado. Vﾃ｡ para a aba "Ativaﾃｧﾃ｣o de App".</p>`;
            } else {
                content += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                devices.forEach(d => {
                    content += `
                        <div class="bg-gray-800 p-4 rounded-lg shadow-lg space-y-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold">${d.deviceName}</h3>
                                    <p class="text-sm text-gray-400">${d.clientName} - ${d.clientPhone}</p>
                                </div>
                                ${getStatusBadge(d.status)}
                            </div>
                            <p class="text-xs">UID: ${d.id}</p>
                            <p class="text-xs">Licenﾃｧa: ${d.licenseId}</p>
                            <p class="text-xs">Validade: ${new Date(d.validUntil.seconds * 1000).toLocaleDateString()}</p>
                            <p class="text-xs">ﾃ嗟timo Sincronismo: ${d.lastSync ? new Date(d.lastSync.seconds * 1000).toLocaleString() : 'N/A'}</p>
                            <div class="pt-2 border-t border-gray-700">
                                <input type="url" value="${d.googleDriveFolderUrl || ''}" placeholder="Cole o link da pasta do Drive aqui" class="w-full text-xs p-1 bg-gray-700 rounded" onchange="updateDriveLink('${d.id}', this.value)">
                            </div>
                            <div class="flex space-x-2 mt-2">
                                <button class="bg-red-600 text-white px-3 py-1 text-sm rounded" onclick="confirmDeleteDevice('${d.id}', '${d.licenseId}')">Excluir</button>
                                <button class="bg-gray-600 text-white px-3 py-1 text-sm rounded" onclick="toggleBlockDevice('${d.id}', '${d.status}')">${d.status === 'blocked' ? 'Desbloquear' : 'Bloquear'}</button>
                            </div>
                        </div>
                    `;
                });
                content += `</div>`;
            }
            tabContents.monitoring.innerHTML = content;
        }

        window.updateDriveLink = async (deviceId, url) => {
            try {
                await updateDoc(doc(db, 'devices', deviceId), { googleDriveFolderUrl: url });
                showNotification("Sucesso", "Link do Google Drive atualizado!");
            } catch (e) {
                showNotification("Erro", "Nﾃ｣o foi possﾃｭvel atualizar o link.");
            }
        };
        
        window.confirmDeleteDevice = (deviceId, licenseId) => {
            const confirmation = prompt("Para confirmar a exclusﾃ｣o, digite 'EXCLUIR' e clique em OK. Esta aﾃｧﾃ｣o nﾃ｣o pode ser desfeita.");
            if (confirmation === 'EXCLUIR') {
                deleteDevice(deviceId, licenseId);
            } else {
                showNotification("Cancelado", "A exclusﾃ｣o foi cancelada.");
            }
        };

        async function deleteDevice(deviceId, licenseId) {
            try {
                // Deleta o dispositivo
                await deleteDoc(doc(db, "devices", deviceId));

                // Libera a licenﾃｧa
                const licenseQuery = query(collection(db, "licenses"), where("licenseId", "==", licenseId));
                const licenseSnapshot = await getDocs(licenseQuery);
                if (!licenseSnapshot.empty) {
                    const licenseDocRef = licenseSnapshot.docs[0].ref;
                    await updateDoc(licenseDocRef, { status: 'available', deviceId: null });
                }
                showNotification("Sucesso", "Dispositivo excluﾃｭdo e licenﾃｧa liberada.");
            } catch (error) {
                console.error("Erro ao excluir dispositivo: ", error);
                showNotification("Erro", `Falha ao excluir: ${error.message}`);
            }
        }
        
        window.toggleBlockDevice = async (deviceId, currentStatus) => {
             const newStatus = currentStatus === 'blocked' ? 'active' : 'blocked';
             try {
                await updateDoc(doc(db, 'devices', deviceId), { status: newStatus });
                showNotification("Sucesso", `Dispositivo ${newStatus === 'blocked' ? 'bloqueado' : 'desbloqueado'}.`);
            } catch (e) {
                showNotification("Erro", "Nﾃ｣o foi possﾃｭvel alterar o status do dispositivo.");
            }
        }


        // --- ABA DE ATIVAﾃﾃグ ---
        let html5QrCode;
        function renderActivationTab() {
            tabContents.activation.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-lime-400">Ativar Dispositivo via QR Code</h2>
                <div id="qr-reader" class="w-full max-w-md mx-auto"></div>
                <div id="qr-result" class="mt-4 text-center"></div>
            `;
            html5QrCode = new Html5Qrcode("qr-reader");
            startQrScanner();
        }

        function startQrScanner() {
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure).catch(err => {
                document.getElementById('qr-reader').innerHTML = `<p class="text-red-500">Erro ao iniciar a cﾃ｢mera: ${err}. Certifique-se de dar permissﾃ｣o.</p>`;
            });
        }
        
        function stopQrScanner() {
             if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Falha ao parar scanner", err));
             }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            stopQrScanner();
            document.getElementById('qr-result').innerText = `QR Code detectado! Processando...`;
            try {
                const data = JSON.parse(decodedText);
                if (data.uid && data.ns) {
                    // Verificar se o dispositivo jﾃ｡ existe
                    const deviceRef = doc(db, 'devices', data.uid);
                    const deviceSnap = await getDoc(deviceRef);
                    if (deviceSnap.exists()) {
                        showNotification("Dispositivo jﾃ｡ Ativado", `Este dispositivo (UID: ${data.uid}) jﾃ｡ estﾃ｡ registrado.`);
                        startQrScanner(); // Reinicia o scanner
                        return;
                    }
                    
                    document.getElementById('device-uid').value = `UID: ${data.uid}`;
                    document.getElementById('device-ns').value = `N/S: ${data.ns}`;
                    
                    // Carregar licenﾃｧas disponﾃｭveis
                    const licenseSelect = document.getElementById('license-select');
                    licenseSelect.innerHTML = '<option value="">Carregando licenﾃｧas...</option>';
                    const q = query(collection(db, "licenses"), where("installerId", "==", currentInstaller.id), where("status", "==", "available"));
                    const querySnapshot = await getDocs(q);
                    licenseSelect.innerHTML = '<option value="">Selecione uma Licenﾃｧa</option>';
                    if (querySnapshot.empty) {
                        licenseSelect.innerHTML = '<option value="">Nenhuma licenﾃｧa disponﾃｭvel</option>';
                    } else {
                        querySnapshot.forEach((doc) => {
                            licenseSelect.innerHTML += `<option value="${doc.data().licenseId}">${doc.data().licenseId}</option>`;
                        });
                    }
                    
                    activationModal.classList.remove('hidden');
                } else {
                    throw new Error("QR Code invﾃ｡lido.");
                }
            } catch (e) {
                document.getElementById('qr-result').innerText = `Erro ao ler QR Code: ${e.message}`;
                setTimeout(startQrScanner, 2000); // Tenta de novo
            }
        }

        function onScanFailure(error) {
            // Ignorar erros de "QR code not found"
        }

        document.getElementById('activation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const deviceUID = document.getElementById('device-uid').value.replace('UID: ', '');
            const licenseId = document.getElementById('license-select').value;
            if(!licenseId) {
                showNotification("Atenﾃｧﾃ｣o", "Selecione uma licenﾃｧa vﾃ｡lida.");
                return;
            }

            const validityMonths = parseInt(document.getElementById('validity-select').value);
            const activationDate = new Date();
            const expiryDate = new Date(activationDate);
            expiryDate.setMonth(expiryDate.getMonth() + validityMonths);

            const newDeviceData = {
                installerId: currentInstaller.id,
                serialNumber: document.getElementById('device-ns').value.replace('N/S: ', ''),
                clientName: document.getElementById('client-name').value,
                clientPhone: document.getElementById('client-phone').value,
                deviceName: document.getElementById('device-name').value,
                licenseId: licenseId,
                activatedOn: activationDate,
                validUntil: expiryDate,
                googleDriveFolderUrl: document.getElementById('drive-link').value,
                status: 'active',
                lastSync: null
            };

            try {
                // Salva o novo dispositivo
                await setDoc(doc(db, "devices", deviceUID), newDeviceData);

                // Marca a licenﾃｧa como usada
                const licenseQuery = query(collection(db, "licenses"), where("licenseId", "==", licenseId));
                const licenseSnapshot = await getDocs(licenseQuery);
                if (!licenseSnapshot.empty) {
                    const licenseDocRef = licenseSnapshot.docs[0].ref;
                    await updateDoc(licenseDocRef, { status: 'in_use', deviceId: deviceUID });
                }

                showNotification("Sucesso!", "Dispositivo ativado e configurado com sucesso.");
                activationModal.classList.add('hidden');
                document.getElementById('activation-form').reset();
                startQrScanner();
            } catch (error) {
                console.error("Erro ao ativar dispositivo: ", error);
                showNotification("Erro de Ativaﾃｧﾃ｣o", `Falha: ${error.message}`);
            }
        });

        document.getElementById('cancel-activation').addEventListener('click', () => {
            activationModal.classList.add('hidden');
            document.getElementById('activation-form').reset();
            startQrScanner();
        });


        // --- ABA HOSPEDAGEM DE ARTES (GOOGLE DRIVE) ---
        function renderDriveTab() {
            tabContents.drive.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4 text-lime-400">Gerenciador de Artes no Google Drive</h2>
                    <div id="drive-auth-view">
                        <p class="mb-4">Para gerenciar arquivos, vocﾃｪ precisa conectar sua conta Google Drive.</p>
                        <button id="drive-auth-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded">Conectar Google Drive</button>
                    </div>
                    <div id="drive-file-manager" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <div id="drive-breadcrumbs" class="text-gray-400"></div>
                            <button id="drive-disconnect-button" class="bg-red-600 text-white px-3 py-1 text-sm rounded">Desconectar</button>
                        </div>
                        <div class="flex space-x-2 mb-4">
                            <input type="text" id="new-folder-name" placeholder="Nome da nova pasta" class="flex-grow p-2 bg-gray-700 rounded">
                            <button id="create-folder-button" class="bg-lime-500 text-gray-900 font-bold px-4 py-2 rounded">Criar Pasta</button>
                            <label class="bg-blue-500 text-white font-bold px-4 py-2 rounded cursor-pointer">
                                <span>Enviar Arquivo</span>
                                <input type="file" id="upload-file-input" class="hidden">
                            </label>
                        </div>
                        <div id="drive-items-container" class="min-h-[200px] bg-gray-700 p-2 rounded"></div>
                        <div id="file-upload-status" class="mt-2 text-sm"></div>
                    </div>
                </div>
            `;
            document.getElementById('drive-auth-button').addEventListener('click', () => tokenClient.requestAccessToken({prompt: 'consent'}));
            document.getElementById('drive-disconnect-button').addEventListener('click', () => gapi.client.oauth2.revoke(gapi.client.getToken().access_token, () => {
                 gapi.client.setToken(null);
                 document.getElementById('drive-auth-view').classList.remove('hidden');
                 document.getElementById('drive-file-manager').classList.add('hidden');
            }));
            document.getElementById('create-folder-button').addEventListener('click', createFolder);
            document.getElementById('upload-file-input').addEventListener('change', handleFileUpload);
        }
        
        function initializeGapiClient() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                });
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: GOOGLE_SCOPES,
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            document.getElementById('drive-auth-view').classList.add('hidden');
                            document.getElementById('drive-file-manager').classList.remove('hidden');
                            listFiles();
                        }
                    },
                });
            });
        }
        
        let currentDriveFolderId = 'root';
        let breadcrumbs = [{id: 'root', name: 'Meu Drive'}];

        async function listFiles(folderId = 'root') {
             currentDriveFolderId = folderId;
             document.getElementById('drive-items-container').innerHTML = `<p>Carregando...</p>`;
             try {
                const res = await gapi.client.drive.files.list({
                    'pageSize': 50,
                    'q': `'${folderId}' in parents and trashed = false`,
                    'fields': "nextPageToken, files(id, name, mimeType, webViewLink)"
                });
                renderDriveItems(res.result.files);
                updateBreadcrumbs();
            } catch (e) {
                console.error(e);
                showNotification("Erro no Drive", `Nﾃ｣o foi possﾃｭvel listar os arquivos. Tente reconectar.`);
                gapi.client.setToken(null);
                document.getElementById('drive-auth-view').classList.remove('hidden');
                document.getElementById('drive-file-manager').classList.add('hidden');
            }
        }
        
        function renderDriveItems(files) {
            const container = document.getElementById('drive-items-container');
            container.innerHTML = '';
            files.forEach(file => {
                const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                const icon = isFolder ? '刀' : '塘';
                const itemEl = document.createElement('div');
                itemEl.className = 'drive-item flex justify-between items-center p-2 rounded cursor-pointer';
                itemEl.innerHTML = `
                    <div class="flex-grow">
                        <span>${icon} ${file.name}</span>
                    </div>
                    <div class="space-x-2">
                        <button class="text-xs text-red-400" onclick="event.stopPropagation(); deleteDriveFile('${file.id}', '${file.name}')">Excluir</button>
                        <button class="text-xs text-blue-400" onclick="event.stopPropagation(); copyDriveLink('${file.webViewLink}')">Copiar Link</button>
                    </div>
                `;
                if(isFolder) {
                    itemEl.addEventListener('click', () => {
                        breadcrumbs.push({id: file.id, name: file.name});
                        listFiles(file.id);
                    });
                }
                container.appendChild(itemEl);
            });
        }
        
        function updateBreadcrumbs() {
            const container = document.getElementById('drive-breadcrumbs');
            container.innerHTML = breadcrumbs.map((b, index) => 
                `<span class="cursor-pointer hover:underline" data-id="${b.id}" data-index="${index}">${b.name}</span>`
            ).join(' / ');
            container.querySelectorAll('span').forEach(span => {
                span.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const index = parseInt(e.target.dataset.index);
                    breadcrumbs = breadcrumbs.slice(0, index + 1);
                    listFiles(id);
                });
            });
        }

        async function createFolder() {
            const folderName = document.getElementById('new-folder-name').value;
            if (!folderName) return;
            try {
                await gapi.client.drive.files.create({
                    resource: {
                        'name': folderName,
                        'mimeType': 'application/vnd.google-apps.folder',
                        'parents': [currentDriveFolderId]
                    }
                });
                document.getElementById('new-folder-name').value = '';
                listFiles(currentDriveFolderId);
            } catch (e) { showNotification("Erro", "Falha ao criar pasta."); }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const metadata = {
                'name': file.name,
                'parents': [currentDriveFolderId]
            };
            
            const uploader = new gapi.client.drive.files.create({
                resource: metadata,
                media: {
                    body: file
                },
                fields: 'id'
            });

            const statusEl = document.getElementById('file-upload-status');
            statusEl.textContent = `Enviando ${file.name}...`;

            uploader.execute((resp) => {
                if (resp.error) {
                    statusEl.textContent = `Erro no envio: ${resp.error.message}`;
                } else {
                    statusEl.textContent = `${file.name} enviado com sucesso!`;
                    listFiles(currentDriveFolderId);
                    setTimeout(() => statusEl.textContent = '', 3000);
                }
            });
        }
        
        window.copyDriveLink = async (link) => {
            try {
                await navigator.clipboard.writeText(link);
                showNotification("Sucesso", "Link copiado para a ﾃ｡rea de transferﾃｪncia!");
            } catch (err) {
                showNotification("Erro", "Nﾃ｣o foi possﾃｭvel copiar o link.");
            }
        };

        window.deleteDriveFile = async (fileId, fileName) => {
             if (!confirm(`Tem certeza que deseja excluir '${fileName}'?`)) return;
             try {
                await gapi.client.drive.files.delete({ fileId: fileId });
                listFiles(currentDriveFolderId);
             } catch(e) { showNotification("Erro", "Falha ao excluir o arquivo."); }
        };

        // --- ABAS DE MANUTENﾃﾃグ E AVISO ---
        function renderMaintenanceTab(devices = []) {
             let content = `<h2 class="text-2xl font-bold mb-4 text-lime-400">Manutenﾃｧﾃ｣o Remota</h2>`;
             if (devices.length === 0) {
                content += `<p>Nenhum dispositivo para gerenciar.</p>`;
             } else {
                content += `<div class="space-y-2">`;
                devices.forEach(d => {
                    content += `
                        <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                            <span>${d.deviceName} (${d.clientName})</span>
                            <button class="bg-orange-500 text-white font-bold px-4 py-2 rounded" onclick="requestReboot('${d.id}')">Reiniciar Dispositivo</button>
                        </div>
                    `;
                });
                content += `</div>`;
             }
             tabContents.maintenance.innerHTML = content;
        }

        window.requestReboot = async (deviceId) => {
            if (!confirm("Tem certeza que deseja reiniciar este dispositivo?")) return;
            try {
                await updateDoc(doc(db, 'devices', deviceId), { rebootRequested: new Date() });
                showNotification("Sucesso", "Comando de reinicializaﾃｧﾃ｣o enviado.");
            } catch (e) {
                showNotification("Erro", "Falha ao enviar comando.");
            }
        };

        function renderAdvisoryTab(devices = []) {
            let content = `<h2 class="text-2xl font-bold mb-4 text-lime-400">Aviso de Inadimplﾃｪncia</h2>`;
            if (devices.length === 0) {
                content += `<p>Nenhum dispositivo para gerenciar.</p>`;
            } else {
                content += `<div class="space-y-4">`;
                devices.forEach(d => {
                    const message = d.advisoryMessage || `Pagamento pendente. Contato: ${currentInstaller.phone}`;
                    content += `
                        <div class="bg-gray-800 p-4 rounded-lg">
                           <h3 class="font-bold">${d.deviceName} (${d.clientName})</h3>
                           <textarea class="w-full bg-gray-700 p-2 rounded mt-2 text-sm" rows="2" id="msg-${d.id}">${message}</textarea>
                           <div class="flex space-x-2 mt-2">
                               <button class="w-full ${d.showAdvisory ? 'bg-gray-500' : 'bg-green-600'} text-white font-bold py-2 rounded" onclick="toggleAdvisory('${d.id}', false, '${d.id}')">Desativar Aviso</button>
                               <button class="w-full bg-red-600 text-white font-bold py-2 rounded" onclick="toggleAdvisory('${d.id}', true, '${d.id}')">Ativar Aviso</button>
                           </div>
                        </div>
                    `;
                });
                content += `</div>`;
            }
            tabContents.advisory.innerHTML = content;
        }
        
        window.toggleAdvisory = async (deviceId, show, elementId) => {
            const message = document.getElementById(`msg-${elementId}`).value;
            try {
                 await updateDoc(doc(db, 'devices', deviceId), { showAdvisory: show, advisoryMessage: message });
                 showNotification("Sucesso", `Aviso ${show ? 'ativado' : 'desativado'}.`);
            } catch(e) {
                showNotification("Erro", "Nﾃ｣o foi possﾃｭvel atualizar o aviso.");
            }
        }
        
        // --- UTILITﾃヽIOS ---
        const modal = document.getElementById('notification-modal');
        function showNotification(title, message) {
            modal.querySelector('#notification-title').textContent = title;
            modal.querySelector('#notification-message').textContent = message;
            modal.classList.remove('hidden');
        }
        document.getElementById('notification-close').addEventListener('click', () => modal.classList.add('hidden'));

    </script>
</body>
</html>
